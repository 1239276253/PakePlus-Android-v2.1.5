<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>苏格拉底 AI - 学习助手</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* 强制覆盖全屏，解决安卓 WebView 高度塌陷问题 */
        body, html {
            height: 100%;
            width: 100%;
            overflow: hidden; /* 禁止 body 滚动，只让内部 div 滚动 */
            position: fixed; /* 锁死在屏幕上 */
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: url('https://4kwallpapers.com/images/wallpapers/macos-big-sur-apple-layers-fluidic-colorful-wwdc-2020-5120x2880-1455.jpg') no-repeat center center fixed; 
            background-size: cover;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent; /* 移除点击高亮 */
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 0; 
            box-shadow: none;
        }
        
        @media (min-width: 768px) {
            .glass-panel {
                background: rgba(255, 255, 255, 0.85);
                border: 1px solid rgba(255, 255, 255, 0.4);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
            }
        }

        .cursor-blink {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: #2563eb;
            margin-left: 2px;
            vertical-align: sub;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* 移动端侧边栏动画 */
        .sidebar-mobile {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50; /* 确保层级够高 */
        }
        
        .sidebar-backdrop {
            z-index: 40;
        }

        /* 修复滚动条 */
        .custom-scroll {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOS/Android 平滑滚动 */
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
    </style>
</head>
<body class="flex items-center justify-center md:p-8 p-0">
    <div id="root" class="w-full h-full md:max-w-6xl md:max-h-[900px]"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 配置后端 IP (保持你正确的 IP)
        const API_HOST = "10.71.88.98";
        const API_PORT = "8080";
        const API_BASE = `http://${API_HOST}:${API_PORT}`;

        const App = () => {
            const [file, setFile] = useState(null);
            const [chapters, setChapters] = useState([]);
            const [selectedChapterIndex, setSelectedChapterIndex] = useState('');
            const [output, setOutput] = useState('');
            const [status, setStatus] = useState('idle');
            const [filename, setFilename] = useState('');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('checking');
            const [errorMsg, setErrorMsg] = useState('');
            
            // 调试日志系统
            const [logs, setLogs] = useState([]);
            const addLog = (msg) => {
                const time = new Date().toLocaleTimeString();
                setLogs(prev => [`[${time}] ${msg}`, ...prev].slice(0, 50));
            };

            const outputRef = useRef(null);
            const fileInputRef = useRef(null);

            // 启动时检查连接
            useEffect(() => {
                addLog("App started. Checking connection...");
                checkBackendConnection();
            }, []);

            const checkBackendConnection = async () => {
                setConnectionStatus('checking');
                setErrorMsg('');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                try {
                    addLog(`Fetching ${API_BASE}...`);
                    await fetch(API_BASE, { method: 'GET', mode: 'cors', signal: controller.signal });
                    setConnectionStatus('connected');
                    addLog("Connection successful!");
                } catch (err) {
                    let errorMessage = err.message;
                    let isNetworkError = false;

                    if (err.name === 'AbortError') {
                        errorMessage = "连接超时 (3s)";
                        isNetworkError = true;
                    } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                        isNetworkError = true;
                        errorMessage = "网络不通 (防火墙/IP错误)";
                        if (window.location.protocol === 'https:' && API_BASE.startsWith('http:')) {
                            errorMessage = "混合内容错误 (HTTPS->HTTP)";
                        }
                    }
                    
                    if (isNetworkError) {
                        console.warn("Connect fail:", errorMessage);
                        setConnectionStatus('disconnected');
                        setErrorMsg(errorMessage);
                        addLog(`Connect Error: ${errorMessage}`);
                    } else {
                        // 404/500 其实说明连上了
                        setConnectionStatus('connected');
                        addLog("Connection established (Server responded)");
                    }
                } finally {
                    clearTimeout(timeoutId);
                }
            };

            useEffect(() => {
                if (outputRef.current) {
                    outputRef.current.scrollTo({ top: outputRef.current.scrollHeight, behavior: 'smooth' });
                }
            }, [output]);

            // 手动触发文件选择（暴力模式）
            const forceTriggerUpload = () => {
                addLog("Button clicked. Attempting to open file picker via .click()...");
                if(fileInputRef.current) {
                    try {
                        fileInputRef.current.click();
                        addLog("DOM .click() executed. If no dialog appears, WebView blocked it.");
                    } catch (e) {
                        addLog(`Error calling click(): ${e.message}`);
                        alert("无法调起文件选择: " + e.message);
                    }
                } else {
                    addLog("Error: fileInputRef is null");
                }
            }

            // 文件上传处理
            const handleFileUpload = async (e) => {
                const selectedFile = e.target.files[0];
                addLog(`File input changed: ${selectedFile ? selectedFile.name : 'No file selected'}`);
                
                if (!selectedFile) return;
                
                setFile(selectedFile);
                setFilename(selectedFile.name);
                setStatus('analyzing');
                setChapters([]);
                
                const formData = new FormData();
                formData.append('file', selectedFile);
                try {
                    addLog("Uploading file...");
                    const res = await fetch(`${API_BASE}/api/analyze-structure`, { method: 'POST', body: formData });
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    setChapters(data);
                    setStatus('ready');
                    addLog(`Analysis complete. Chapters: ${data.length}`);
                    if (data.length > 0) setSelectedChapterIndex(0);
                } catch (err) {
                    const msg = `上传失败: ${err.message}`;
                    alert(msg);
                    addLog(msg);
                    setStatus('idle');
                    setFile(null);
                    setConnectionStatus('disconnected');
                }
            };

            const handleStartLearning = async () => {
                if (selectedChapterIndex === '') return;
                setMobileMenuOpen(false);
                const chapter = chapters[selectedChapterIndex];
                setStatus('streaming');
                setOutput('');
                addLog(`Starting learning: ${chapter.title}`);
                
                const processStreamBuffer = (buffer) => {
                    const lines = buffer.split('\n');
                    let cleanText = '';
                    for (let line of lines) {
                        if (line.trim() === '') continue;
                        if (line.startsWith('data:')) {
                            let content = line.substring(5);
                            if (content.startsWith(' ')) content = content.substring(1);
                            content = content.replace(/\\n/g, '\n');
                            cleanText += content;
                        }
                    }
                    return cleanText;
                };

                const params = new URLSearchParams({
                    filename: filename,
                    title: chapter.title,
                    startPage: chapter.startPage,
                    endPage: chapter.endPage
                });

                try {
                    const res = await fetch(`${API_BASE}/api/generate-socratic?${params.toString()}`);
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const text = processStreamBuffer(chunk);
                        setOutput(prev => prev + text);
                    }
                    setStatus('done');
                    addLog("Streaming complete");
                } catch (err) {
                    console.error(err);
                    setOutput(prev => prev + `\n\n[连接中断: ${err.message}]`);
                    setStatus('ready');
                    setConnectionStatus('disconnected');
                    addLog(`Stream error: ${err.message}`);
                }
            };

            const formatInlineStyles = (text) => text.split(/(`.*?`|\*\*.*?\*\*)/g).map((part, idx) => {
                if (part.startsWith('`') && part.endsWith('`')) return <code key={idx} className="bg-gray-100 text-pink-600 px-1.5 py-0.5 rounded text-sm font-mono mx-0.5 border border-gray-200">{part.slice(1, -1)}</code>;
                if (part.startsWith('**') && part.endsWith('**')) return <strong key={idx} className="text-gray-900 font-bold">{part.slice(2, -2)}</strong>;
                return part;
            });

            const renderContent = (text) => {
                if (!text) return null;
                const rawLines = text.split('\n');
                const blocks = [];
                let currentTextBuffer = [];
                const flushBuffer = () => { if (currentTextBuffer.length > 0) { blocks.push({ type: 'paragraph', content: currentTextBuffer.join(' ') }); currentTextBuffer = []; } };

                rawLines.forEach((line) => {
                    const trimmed = line.trim();
                    if (!trimmed) { flushBuffer(); return; }
                    if (trimmed.startsWith('#') || trimmed.startsWith('>') || trimmed.match(/^(\d+[\.|、])\s/) || trimmed.startsWith('- ') || trimmed.startsWith('• ')) {
                        flushBuffer();
                        if (trimmed.startsWith('#')) blocks.push({ type: 'header', content: line });
                        else if (trimmed.startsWith('>')) blocks.push({ type: 'quote', content: line });
                        else if (trimmed.match(/^(\d+[\.|、])\s/)) blocks.push({ type: 'ordered-list', content: line });
                        else blocks.push({ type: 'unordered-list', content: line });
                    } else currentTextBuffer.push(line);
                });
                flushBuffer();

                return blocks.map((block, i) => {
                    if (block.type === 'header') return <h3 key={i} className="text-lg font-bold text-gray-800 mt-5 mb-2">{block.content.replace(/^#+ /, '')}</h3>;
                    if (block.type === 'paragraph') return <p key={i} className="text-gray-600 mb-4 leading-7 text-justify">{formatInlineStyles(block.content)}</p>;
                    return <div key={i}>{block.content}</div>;
                });
            };

            return (
                <div className="glass-panel w-full h-full md:rounded-2xl flex flex-col overflow-hidden animate-in relative">
                    
                    {/* 顶部导航栏 */}
                    <div className="h-14 bg-white/70 border-b border-gray-100 flex items-center justify-between px-4 shrink-0 backdrop-blur-md z-30 relative shadow-sm">
                        <button className="md:hidden p-2 -ml-2 text-gray-600 hover:bg-black/5 rounded-lg active:scale-95 transition-all" onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>
                            <i className={`ph text-2xl ${mobileMenuOpen ? 'ph-x' : 'ph-list'}`}></i>
                        </button>

                        <div className="text-base font-semibold text-gray-700 flex items-center gap-2">
                            <i className="ph ph-student text-xl text-blue-500"></i> 
                            <span>苏格拉底 AI</span>
                        </div>
                        
                        {/* 状态指示灯 */}
                        <div className="flex items-center gap-2" onClick={checkBackendConnection}>
                            <div className={`w-3 h-3 rounded-full shadow-sm border border-white/50 ${
                                connectionStatus === 'connected' ? 'bg-green-500' : 
                                connectionStatus === 'checking' ? 'bg-yellow-400 animate-pulse' : 'bg-red-500'
                            }`}></div>
                        </div>
                    </div>
                    
                    {/* 错误提示条 */}
                    {connectionStatus === 'disconnected' && (
                        <div className="bg-red-50 px-4 py-2 text-xs text-red-600 border-b border-red-100 flex items-center justify-between z-20">
                            <span>未连接: {errorMsg}</span>
                            <button onClick={checkBackendConnection} className="text-red-700 font-bold px-2">重试</button>
                        </div>
                    )}

                    <div className="flex flex-1 overflow-hidden relative">
                        {/* 移动端遮罩 */}
                        <div className={`md:hidden fixed inset-0 bg-black/30 z-40 sidebar-backdrop transition-opacity duration-300 ${mobileMenuOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={() => setMobileMenuOpen(false)}></div>

                        {/* 侧边栏 */}
                        <div className={`w-72 md:w-72 bg-white md:bg-gray-50/50 border-r border-gray-100 flex flex-col shrink-0 absolute md:relative h-full sidebar-mobile shadow-xl md:shadow-none ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                            
                            <div className="p-4 flex-1 overflow-y-auto custom-scroll relative">
                                <div className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 px-1">资料库</div>
                                
                                {/* 方案A: 漂亮的上传按钮 (不再包裹 Input，改为 onClick 触发) */}
                                <div 
                                    className="flex items-center gap-3 p-4 rounded-xl bg-white border border-gray-100 shadow-sm active:scale-[0.98] transition-all cursor-pointer group hover:border-blue-300 overflow-hidden mb-2"
                                    onClick={forceTriggerUpload}
                                >
                                    <div className="w-12 h-12 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center shrink-0 group-hover:bg-blue-100 transition-colors">
                                        {status === 'analyzing' ? <i className="ph ph-spinner animate-spin text-2xl"></i> : <i className="ph ph-file-pdf text-2xl"></i>}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="text-sm font-bold text-gray-800 truncate">{file ? file.name : "点击上传教材"}</div>
                                        <div className="text-xs text-gray-500 mt-1 truncate">
                                            {status === 'analyzing' ? "正在解析结构..." : "测试方案A"}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* 方案B: 原生 HTML 上传 (备用通道，最原始的形态) */}
                                <div className="p-2 border border-dashed border-red-300 rounded text-[10px] text-gray-500 mb-4 bg-red-50">
                                    <p className="mb-1 text-red-500 font-bold">方案B: 原生控件 (无样式)</p>
                                    <p className="mb-1 text-xs text-gray-400">如果点击无反应，说明APK权限被拒</p>
                                    {/* 关键修改：
                                        1. 移除 accept 属性，允许所有文件
                                        2. 移除 ref 引用，直接展示
                                        3. 移除 disabled，强制允许点击 
                                    */}
                                    <input 
                                        type="file" 
                                        onChange={handleFileUpload} 
                                        className="w-full"
                                    />
                                </div>
                                
                                <div className="mt-4">
                                    <div className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 px-1">章节目录</div>
                                    {chapters.length === 0 ? (
                                        <div className="px-4 py-10 text-center text-gray-400 select-none bg-gray-50/50 rounded-lg border border-dashed border-gray-200">
                                            <i className="ph ph-books text-3xl mb-2 opacity-30"></i>
                                            <p className="text-xs">请先上传文件</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-1">
                                            {chapters.map((ch, idx) => (
                                                <div key={idx} onClick={() => setSelectedChapterIndex(idx)} className={`p-3 rounded-lg text-sm cursor-pointer transition-all border ${selectedChapterIndex === idx ? 'bg-blue-50 border-blue-100 text-blue-700 font-medium' : 'border-transparent text-gray-600 hover:bg-gray-50'}`}>
                                                    <div className="flex gap-2">
                                                        <span className="opacity-50 text-xs mt-0.5">{idx + 1}.</span>
                                                        <span className="leading-snug">{ch.title}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="p-4 border-t border-gray-100 bg-white md:bg-transparent pb-safe">
                                <button onClick={handleStartLearning} disabled={status !== 'ready' && status !== 'done'} className={`w-full py-3.5 rounded-xl font-bold text-sm shadow-lg transition-all flex items-center justify-center gap-2 ${status === 'streaming' ? 'bg-gray-100 text-gray-400 shadow-none' : 'bg-blue-600 text-white shadow-blue-500/30 active:scale-95'}`}>
                                    {status === 'streaming' ? '正在生成...' : '开始学习'}
                                </button>
                                <div className="mt-2 text-[10px] text-center text-gray-300 font-mono">
                                    {API_HOST}
                                </div>
                            </div>
                        </div>

                        {/* 主内容区 + 调试日志 */}
                        <div className="flex-1 bg-white flex flex-col relative w-full h-full overflow-hidden">
                            <div className="flex-1 overflow-y-auto custom-scroll p-5 md:p-12 pb-24 scroll-smooth">
                                {output ? (
                                    <div className="max-w-3xl mx-auto">{renderContent(output)}</div>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-300 select-none pb-20 px-6 text-center">
                                        <div className="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                                            <i className="ph ph-student text-4xl text-gray-200"></i>
                                        </div>
                                        <p className="text-base font-medium text-gray-400">准备好了吗？</p>
                                        <p className="text-xs text-gray-300 mt-2">上传 PDF 教材，开启苏格拉底式学习</p>
                                    </div>
                                )}
                            </div>

                            {/* 内置屏幕日志控制台 (调试用) */}
                            <div className="h-32 bg-black/90 text-green-400 text-[10px] font-mono p-2 overflow-y-auto w-full z-50 border-t border-gray-700">
                                <div className="text-white font-bold border-b border-gray-700 mb-1 pb-1">Debug Console</div>
                                {logs.length === 0 && <div className="opacity-50">Waiting for logs...</div>}
                                {logs.map((log, i) => (
                                    <div key={i} className="whitespace-pre-wrap">{log}</div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>