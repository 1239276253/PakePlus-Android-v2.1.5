<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>苏格拉底 AI - 学习助手</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: url('https://4kwallpapers.com/images/wallpapers/macos-big-sur-apple-layers-fluidic-colorful-wwdc-2020-5120x2880-1455.jpg') no-repeat center center fixed; 
            background-size: cover;
            overscroll-behavior-y: none;
            user-select: none; /* 防止移动端长按选中文本干扰 */
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.90); /* 稍微增加不透明度 */
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 0; 
            box-shadow: none;
        }
        
        @media (min-width: 768px) {
            .glass-panel {
                background: rgba(255, 255, 255, 0.85);
                border: 1px solid rgba(255, 255, 255, 0.4);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
            }
        }

        .cursor-blink {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: #2563eb;
            margin-left: 2px;
            vertical-align: sub;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .list-item-card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0,0,0,0.03);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .sidebar-mobile {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 状态指示灯动画 */
        .ping-slow {
            animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        @keyframes ping {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
    </style>
</head>
<body class="h-[100dvh] w-screen overflow-hidden flex items-center justify-center md:p-8 p-0">
    <div id="root" class="w-full h-full md:max-w-6xl md:max-h-[900px]"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 配置后端 IP
        const API_HOST = "10.71.88.98";
        const API_PORT = "8080";
        const API_BASE = `http://${API_HOST}:${API_PORT}`;

        const App = () => {
            const [file, setFile] = useState(null);
            const [chapters, setChapters] = useState([]);
            const [selectedChapterIndex, setSelectedChapterIndex] = useState('');
            const [output, setOutput] = useState('');
            const [status, setStatus] = useState('idle');
            const [filename, setFilename] = useState('');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            // 网络状态相关
            const [connectionStatus, setConnectionStatus] = useState('checking'); // checking, connected, disconnected
            const [errorMsg, setErrorMsg] = useState('');

            const outputRef = useRef(null);
            const fileInputRef = useRef(null); // 引用 input 元素

            // 1. 启动时检查连接
            useEffect(() => {
                checkBackendConnection();
            }, []);

            const checkBackendConnection = async () => {
                setConnectionStatus('checking');
                setErrorMsg('');
                
                const controller = new AbortController();
                // 3秒超时，避免一直在“连接中”
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                try {
                    // 尝试连接后端
                    await fetch(API_BASE, { 
                        method: 'GET', 
                        mode: 'cors',
                        signal: controller.signal 
                    });
                    
                    // 如果能走到这里，说明网络是通的 (或者是 404/500，但也说明服务器在运行)
                    setConnectionStatus('connected');
                } catch (err) {
                    let errorMessage = err.message;
                    let isNetworkError = false;

                    if (err.name === 'AbortError') {
                        errorMessage = "连接超时 (3s) - 请检查IP是否正确";
                        isNetworkError = true;
                    } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                        isNetworkError = true;
                        errorMessage = "无法连接 (网络错误/防火墙拦截)";
                        
                        // 智能诊断：是否是 Mixed Content 问题 (HTTPS 网页请求 HTTP 接口)
                        if (window.location.protocol === 'https:' && API_BASE.startsWith('http:')) {
                            errorMessage = "混合内容错误: HTTPS 网页无法访问 HTTP 接口";
                        }
                    }

                    if (isNetworkError) {
                        // 使用 warn 而不是 error，避免看起来像程序崩溃
                        console.warn("Backend connection check failed:", errorMessage);
                        setConnectionStatus('disconnected');
                        setErrorMsg(errorMessage);
                    } else {
                        // 其他错误（如 JSON 解析错误等）通常意味着服务器有响应，暂且算作在线
                        setConnectionStatus('connected');
                    }
                } finally {
                    // 务必清除定时器
                    clearTimeout(timeoutId);
                }
            };

            useEffect(() => {
                if (outputRef.current) {
                    outputRef.current.scrollTo({ top: outputRef.current.scrollHeight, behavior: 'smooth' });
                }
            }, [output]);

            // 文件上传触发器 - 解决移动端点击问题
            const triggerFileUpload = () => {
                console.log("尝试打开文件选择器...");
                if (fileInputRef.current) {
                    fileInputRef.current.click();
                } else {
                    alert("无法初始化文件上传组件");
                }
            };

            const handleFileUpload = async (e) => {
                const selectedFile = e.target.files[0];
                console.log("文件已选择:", selectedFile);
                
                if (!selectedFile) return;
                
                setFile(selectedFile);
                setFilename(selectedFile.name);
                setStatus('analyzing');
                setChapters([]);
                
                const formData = new FormData();
                formData.append('file', selectedFile);
                try {
                    const res = await fetch(`${API_BASE}/api/analyze-structure`, { method: 'POST', body: formData });
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    setChapters(data);
                    setStatus('ready');
                    if (data.length > 0) setSelectedChapterIndex(0);
                } catch (err) {
                    alert(`上传失败: ${err.message}\n请检查后端控制台是否报错`);
                    setStatus('idle');
                    setFile(null);
                    setConnectionStatus('disconnected'); // 如果上传失败，很可能是断连了
                }
            };

            const handleStartLearning = async () => {
                if (selectedChapterIndex === '') return;
                setMobileMenuOpen(false);
                const chapter = chapters[selectedChapterIndex];
                setStatus('streaming');
                setOutput('');
                
                // 构造流式读取处理
                const processStreamBuffer = (buffer) => {
                    const lines = buffer.split('\n');
                    let cleanText = '';
                    for (let line of lines) {
                        if (line.trim() === '') continue;
                        if (line.startsWith('data:')) {
                            let content = line.substring(5);
                            if (content.startsWith(' ')) content = content.substring(1);
                            content = content.replace(/\\n/g, '\n');
                            cleanText += content;
                        }
                    }
                    return cleanText;
                };

                const params = new URLSearchParams({
                    filename: filename,
                    title: chapter.title,
                    startPage: chapter.startPage,
                    endPage: chapter.endPage
                });

                try {
                    const res = await fetch(`${API_BASE}/api/generate-socratic?${params.toString()}`);
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const text = processStreamBuffer(chunk);
                        setOutput(prev => prev + text);
                    }
                    setStatus('done');
                } catch (err) {
                    console.error(err);
                    setOutput(prev => prev + `\n\n[连接中断: ${err.message}]`);
                    setStatus('ready');
                    setConnectionStatus('disconnected');
                }
            };

            // 渲染相关辅助函数保持不变...
            const formatInlineStyles = (text) => {
                return text.split(/(`.*?`|\*\*.*?\*\*)/g).map((part, idx) => {
                    if (part.startsWith('`') && part.endsWith('`')) return <code key={idx} className="bg-gray-100 text-pink-600 px-1.5 py-0.5 rounded text-sm font-mono mx-0.5 border border-gray-200">{part.slice(1, -1)}</code>;
                    if (part.startsWith('**') && part.endsWith('**')) return <strong key={idx} className="text-gray-900 font-bold">{part.slice(2, -2)}</strong>;
                    return part;
                });
            };

            const renderContent = (text) => {
                if (!text) return null;
                const rawLines = text.split('\n');
                const blocks = [];
                let currentTextBuffer = [];
                const flushBuffer = () => { if (currentTextBuffer.length > 0) { blocks.push({ type: 'paragraph', content: currentTextBuffer.join(' ') }); currentTextBuffer = []; } };

                rawLines.forEach((line) => {
                    const trimmed = line.trim();
                    if (!trimmed) { flushBuffer(); return; }
                    if (trimmed.startsWith('#') || trimmed.startsWith('>') || trimmed.match(/^(\d+[\.|、])\s/) || trimmed.startsWith('- ') || trimmed.startsWith('• ')) {
                        flushBuffer();
                        if (trimmed.startsWith('#')) blocks.push({ type: 'header', content: line });
                        else if (trimmed.startsWith('>')) blocks.push({ type: 'quote', content: line });
                        else if (trimmed.match(/^(\d+[\.|、])\s/)) blocks.push({ type: 'ordered-list', content: line });
                        else blocks.push({ type: 'unordered-list', content: line });
                    } else currentTextBuffer.push(line);
                });
                flushBuffer();

                return blocks.map((block, i) => {
                    // 渲染逻辑简化展示，保持原样
                    if (block.type === 'header') return <h3 key={i} className="text-lg font-bold text-gray-800 mt-5 mb-2">{block.content.replace(/^#+ /, '')}</h3>;
                    if (block.type === 'paragraph') return <p key={i} className="text-gray-600 mb-4 leading-7 text-justify">{formatInlineStyles(block.content)}</p>;
                    return <div key={i}>{block.content}</div>;
                });
            };

            return (
                <div className="glass-panel w-full h-full md:rounded-2xl flex flex-col overflow-hidden animate-in relative">
                    
                    {/* 顶部导航栏 */}
                    <div className="h-14 bg-white/60 border-b border-white/40 flex items-center justify-between px-4 shrink-0 backdrop-blur-md z-30 relative">
                        <button className="md:hidden p-2 -ml-2 text-gray-600 hover:bg-black/5 rounded-lg active:scale-95 transition-all" onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>
                            <i className={`ph text-xl ${mobileMenuOpen ? 'ph-x' : 'ph-list'}`}></i>
                        </button>

                        <div className="text-sm font-semibold text-gray-600 flex items-center gap-2">
                            <i className="ph ph-student text-lg text-blue-500"></i> 
                            <span>苏格拉底 AI</span>
                        </div>
                        
                        {/* 后端状态指示灯 (点击重试) */}
                        <div className="flex items-center gap-2" onClick={checkBackendConnection}>
                            <div className="flex flex-col items-end cursor-pointer">
                                <div className="flex items-center gap-1.5 bg-white/50 px-2 py-1 rounded-full border border-white/60 shadow-sm active:scale-95 transition-transform">
                                    <span className={`w-2 h-2 rounded-full ${
                                        connectionStatus === 'connected' ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 
                                        connectionStatus === 'checking' ? 'bg-yellow-400 animate-pulse' : 'bg-red-500'
                                    }`}></span>
                                    <span className={`text-[10px] font-bold ${
                                        connectionStatus === 'connected' ? 'text-green-700' : 
                                        connectionStatus === 'checking' ? 'text-yellow-700' : 'text-red-600'
                                    }`}>
                                        {connectionStatus === 'connected' ? '在线' : connectionStatus === 'checking' ? '连接中' : '离线'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* 连接错误提示横幅 */}
                    {connectionStatus === 'disconnected' && (
                        <div className="bg-red-50 px-4 py-2 text-[10px] text-red-600 border-b border-red-100 flex items-center justify-between animate-in slide-in-from-top-2">
                            <span>{errorMsg || `无法连接到电脑 (${API_HOST})。请检查防火墙或网络。`}</span>
                            <button onClick={checkBackendConnection} className="underline font-bold shrink-0 ml-2">重试</button>
                        </div>
                    )}

                    <div className="flex flex-1 overflow-hidden relative">
                        {/* 移动端遮罩 */}
                        <div className={`md:hidden fixed inset-0 bg-black/20 z-10 sidebar-backdrop ${mobileMenuOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={() => setMobileMenuOpen(false)}></div>

                        {/* 侧边栏 */}
                        <div className={`w-72 md:w-72 bg-white/95 md:bg-gray-50/40 border-r border-white/40 flex flex-col shrink-0 backdrop-blur-xl md:backdrop-blur-md absolute md:relative z-20 h-full sidebar-mobile ${mobileMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full md:translate-x-0'}`}>
                            
                            <div className="p-5 flex-1 overflow-y-auto">
                                <div className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 px-1">资料库</div>
                                
                                {/* 修复后的文件上传按钮 */}
                                <div 
                                    onClick={triggerFileUpload}
                                    className="flex items-center gap-3 p-3 rounded-xl bg-white/80 border border-white/60 shadow-sm active:scale-95 transition-all cursor-pointer group hover:bg-blue-50/50"
                                >
                                    <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 text-white flex items-center justify-center shadow-lg shadow-blue-500/20">
                                        {status === 'analyzing' ? <i className="ph ph-spinner animate-spin text-xl"></i> : <i className="ph ph-file-pdf text-xl"></i>}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="text-sm font-semibold text-gray-800 truncate">{file ? file.name : "点击上传教材"}</div>
                                        <div className="text-xs text-gray-500 mt-0.5">
                                            {status === 'analyzing' ? "正在分析..." : "支持 PDF 文件"}
                                        </div>
                                    </div>
                                    {/* 隐藏的 Input，通过 ref 触发 */}
                                    <input 
                                        type="file" 
                                        ref={fileInputRef}
                                        accept="application/pdf, .pdf" 
                                        onChange={handleFileUpload} 
                                        className="hidden" 
                                        disabled={status === 'analyzing'} 
                                    />
                                </div>
                                
                                <div className="mt-8">
                                    <div className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 px-1">章节结构</div>
                                    {chapters.length === 0 ? (
                                        <div className="px-6 py-8 text-center text-gray-400 select-none">
                                            <i className="ph ph-books text-3xl mb-2 opacity-30"></i>
                                            <p className="text-xs">暂无内容</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-1.5">
                                            {chapters.map((ch, idx) => (
                                                <div key={idx} onClick={() => setSelectedChapterIndex(idx)} className={`p-3 rounded-lg text-sm cursor-pointer transition-all border border-transparent active:scale-[0.98] ${selectedChapterIndex === idx ? 'bg-white shadow-sm border-gray-100 text-blue-600 font-semibold' : 'text-gray-600 hover:bg-black/5'}`}>
                                                    <div className="flex items-start gap-2">
                                                        <span className="mt-0.5 opacity-70">{idx + 1}.</span>
                                                        <span className="leading-tight">{ch.title}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="p-4 border-t border-gray-100 bg-white/50 backdrop-blur-sm">
                                <button onClick={handleStartLearning} disabled={status !== 'ready' && status !== 'done'} className={`w-full py-3 rounded-xl font-semibold text-sm shadow-md transition-all flex items-center justify-center gap-2 ${status === 'streaming' ? 'bg-gray-100 text-gray-400' : 'bg-blue-600 text-white active:scale-95'}`}>
                                    {status === 'streaming' ? '生成中...' : '开始学习'}
                                </button>
                                {/* 调试信息：显示配置的 IP */}
                                <div className="mt-2 text-[10px] text-center text-gray-400 font-mono">
                                    Server: {API_HOST}:{API_PORT}
                                </div>
                            </div>
                        </div>

                        {/* 主内容区 */}
                        <div className="flex-1 bg-white/70 flex flex-col relative w-full">
                            <div className="flex-1 overflow-y-auto custom-scroll p-5 md:p-12 scroll-smooth">
                                {output ? (
                                    <div className="max-w-3xl mx-auto pb-20">{renderContent(output)}</div>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-300 select-none pb-20">
                                        <i className="ph ph-brain text-5xl mb-4 text-gray-200"></i>
                                        <p className="text-sm text-gray-400">请上传教材并选择章节</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>